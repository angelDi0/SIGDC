<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Menu - SIGDC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .list-group-item .badge { margin-left: 0.5rem; }
      .detail-img { max-height: 240px; max-width: 100%; object-fit: contain; display:block; margin-top:.5rem; }
      .detail-dl dt { font-weight:600; }
      .form-row { margin-bottom:.75rem; }
      .field-label { font-weight:600; margin-bottom:.25rem; display:block; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-white bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand" href="#">SIGDC</a>
        <div>
          <a id="btn-crear-donacion" class="btn btn-sm btn-success me-2" href="/donaciones/crear/">Crear donación</a>
          <a id="btn-crear-solicitud" class="btn btn-sm btn-primary" href="/solicitudes/crear/">Crear solicitud</a>
        </div>
      </div>
    </nav>

    <main class="container py-5">
      <div class="row">
        <div class="col-md-6 mb-4">
          <h5>Donaciones</h5>
          <div id="donaciones-list" class="list-group"></div>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Solicitudes</h5>
          <div id="solicitudes-list" class="list-group"></div>
        </div>
      </div>
    </main>

    <!-- Modal detalle reutilizable -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailModalLabel">Detalle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="detailModalBody">
            <!-- contenido cargado por JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal editar donación -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <form id="editForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Editar donación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="editModalBody">
            <!-- formulario generado dinámicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="editSaveBtn" type="submit" class="btn btn-primary">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal editar solicitud -->
    <div class="modal fade" id="editSolicitudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <form id="editSolicitudForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editSolicitudModalLabel">Editar solicitud</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="editSolicitudModalBody">
            <!-- formulario generado dinámicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="editSolicitudSaveBtn" type="submit" class="btn btn-primary">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="text-center py-4 text-muted">&copy; SIGDC</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v? v.pop():''; }
      const csrftoken = getCookie('csrftoken');

      function badgeClassForEstado(estado){
        if(!estado) return { cls: 'bg-secondary', text: 'Sin estado' };
        const s = String(estado).toLowerCase();
        const display = String(estado).charAt(0).toUpperCase() + String(estado).slice(1).toLowerCase();
        const green = ['disponible','activo','en proceso','en marcha','activa','enproceso','en_proceso'];
        const yellow = ['pendiente','por confirmar','en espera'];
        const red = ['finalizada','cancelada','rechazada','terminada','terminado'];

        if (green.some(x => s.includes(x))) return { cls: 'bg-success', text: display };
        if (yellow.some(x => s.includes(x))) return { cls: 'bg-warning text-dark', text: display };
        if (red.some(x => s.includes(x))) return { cls: 'bg-danger', text: display };
        return { cls: 'bg-secondary', text: display };
      }

      async function loadDonaciones(){
        try{
          const resp = await fetch('/donaciones/api/donaciones/', { credentials: 'same-origin' });
          if(!resp.ok) throw resp;
          const data = await resp.json();
          const container = document.getElementById('donaciones-list');
          container.innerHTML = '';
          if(!data || !data.length) {
            container.innerHTML = '<div class="text-muted p-2">No hay donaciones</div>';
            return;
          }
          data.forEach(d => {
            const estadoInfo = badgeClassForEstado(d.estado);
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-start';
            item.innerHTML = `
              <div>
                <div><strong>${escapeHtml(d.titulo ?? d.tipo ?? 'Sin título')}</strong></div>
                <div class="small text-muted">${escapeHtml(d.descripcion ? d.descripcion.substring(0,80) : '')}</div>
              </div>
              <div class="d-flex align-items-center">
                <span class="badge ${estadoInfo.cls}">${escapeHtml(estadoInfo.text)}</span>
                <div class="btn-group btn-group-sm ms-2">
                  <button class="btn btn-outline-secondary" onclick="openDonacionDetail(${d.id})">Ver</button>
                  <button class="btn btn-outline-primary" onclick="openDonacionEdit(${d.id})">Editar</button>
                  <button class="btn btn-outline-danger" onclick="deleteDonacion(${d.id})">Eliminar</button>
                </div>
              </div>
            `;
            container.appendChild(item);
          });
        }catch(e){
          console.error('Error cargando donaciones', e);
          document.getElementById('donaciones-list').innerHTML = '<div class="text-danger p-2">Error cargando donaciones</div>';
        }
      }

      async function loadSolicitudes(){
        try{
          const resp = await fetch('/solicitudes/api/solicitudes/', { credentials: 'same-origin' });
          if(!resp.ok) throw resp;
          const data = await resp.json();
          const container = document.getElementById('solicitudes-list');
          container.innerHTML = '';
          if(!data || !data.length){
            container.innerHTML = '<div class="text-muted p-2">No hay solicitudes</div>';
            return;
          }
          data.forEach(s => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-start';
            item.innerHTML = `
              <div>
                <strong>${escapeHtml(s.titulo ?? s.tipo ?? 'Sin título')}</strong>
                <div class="small text-muted">${escapeHtml(s.detalle ? s.detalle.substring(0,80) : '')}</div>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="openSolicitudDetail(${s.id})">Ver</button>
                <button class="btn btn-outline-primary" onclick="openSolicitudEdit(${s.id})">Editar</button>
                <button class="btn btn-outline-danger" onclick="deleteSolicitud(${s.id})">Eliminar</button>
              </div>
            `;
            container.appendChild(item);
          });
        }catch(e){
          console.error('Error cargando solicitudes', e);
          document.getElementById('solicitudes-list').innerHTML = '<div class="text-danger p-2">Error cargando solicitudes</div>';
        }
      }

      // detalle solicitud (muestra datos del solicitante formateados)
      async function openSolicitudDetail(id){
        try{
          const resp = await fetch(`/solicitudes/api/solicitudes/${id}/`, { credentials: 'same-origin' });
          if(!resp.ok) throw resp;
          const s = await resp.json();
          const body = document.getElementById('detailModalBody');
          let html = `<h5>${escapeHtml(s.titulo ?? s.tipo ?? `Solicitud #${s.id ?? ''}`)}</h5>`;

          if(s.estado){
            const estadoInfo = badgeClassForEstado(s.estado);
            html += `<p><strong>Estado:</strong> <span class="badge ${estadoInfo.cls}">${escapeHtml(estadoInfo.text)}</span></p>`;
          }

          // Mostrar datos del solicitante (creador) si vienen en la respuesta
          if(s.solicitante){
            const p = s.solicitante;
            html += `<hr><div><strong>Solicitante (creador)</strong>
              <dl class="row mb-0">
                <dt class="col-sm-4">ID</dt><dd class="col-sm-8">${escapeHtml(String(p.id ?? ''))}</dd>
                <dt class="col-sm-4">Usuario</dt><dd class="col-sm-8">${escapeHtml(p.usuario ?? p.usuario_completo ?? '')}</dd>
                <dt class="col-sm-4">Email</dt><dd class="col-sm-8">${escapeHtml(p.email ?? '')}</dd>
                <dt class="col-sm-4">Teléfono</dt><dd class="col-sm-8">${escapeHtml(p.telefono ?? '')}</dd>
                <dt class="col-sm-4">Dirección</dt><dd class="col-sm-8">${escapeHtml(p.direccion ?? '')}</dd>
                <dt class="col-sm-4">Ciudad / País</dt><dd class="col-sm-8">${escapeHtml(((p.ciudad ?? '') + (p.pais ? ' / ' + p.pais : '')))}</dd>
                <dt class="col-sm-4">Rol</dt><dd class="col-sm-8">${escapeHtml(p.rol ?? '')}</dd>
                <dt class="col-sm-4">Activo</dt><dd class="col-sm-8">${p.activo ? 'Sí' : 'No'}</dd>
              </dl>
            </div>`;
          }

          // Mostrar resto de campos de la solicitud (omitimos solicitante)
          html += '<hr><dl class="row detail-dl">';
          const skip = new Set(['id','titulo','tipo','descripcion','solicitante']);
          for(const [k, v] of Object.entries(s)){
            if(skip.has(k)) continue;
            if(v === null || v === undefined || v === '') continue;
            const label = k.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
            if(typeof v === 'object'){
              html += `<dt class="col-sm-4">${escapeHtml(label)}</dt><dd class="col-sm-8"><pre class="mb-0">${escapeHtml(JSON.stringify(v, null, 2))}</pre></dd>`;
              continue;
            }
            html += `<dt class="col-sm-4">${escapeHtml(label)}</dt><dd class="col-sm-8">${escapeHtml(String(v))}</dd>`;
          }
          html += '</dl>';

          if(s.detalle){
            html += `<hr><div><strong>Detalle</strong><p>${escapeHtml(s.detalle).replace(/\n/g,'<br>')}</p></div>`;
          }

          body.innerHTML = html;
          new bootstrap.Modal(document.getElementById('detailModal')).show();
        }catch(e){
          console.error('Error detalle solicitud', e);
          alert('No se pudo cargar detalle de solicitud.');
        }
      }

      // EDIT donaciones 
      let currentEditId = null;
      async function openDonacionEdit(id){
        try{
          const resp = await fetch(`/donaciones/api/donaciones/${id}/`, { credentials: 'same-origin' });
          if(!resp.ok) throw resp;
          const d = await resp.json();
          currentEditId = id;
          const body = document.getElementById('editModalBody');
          body.innerHTML = '';

          const skip = new Set(['id','created_at','updated_at','categoria','imagen','fecha_publicacion','donante','estado']);
          for(const [k, v] of Object.entries(d)){
            if(skip.has(k)) continue;

            const label = k.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
            const row = document.createElement('div');
            row.className = 'form-row';

            const lab = document.createElement('label');
            lab.className = 'field-label';
            lab.htmlFor = 'field-'+k;
            lab.textContent = label;
            row.appendChild(lab);

            let input;
            if(typeof v === 'boolean'){
              input = document.createElement('input');
              input.type = 'checkbox';
              input.id = 'field-'+k;
              input.checked = !!v;
              input.dataset.fieldType = 'boolean';
            } else if(typeof v === 'number'){
              input = document.createElement('input');
              input.type = 'number';
              input.id = 'field-'+k;
              input.value = v;
              input.className = 'form-control';
            } else if(k === 'descripcion' || (typeof v === 'string' && v.length > 120)){
              input = document.createElement('textarea');
              input.id = 'field-'+k;
              input.className = 'form-control';
              input.rows = 4;
              input.value = v ?? '';
            } else {
              input = document.createElement('input');
              input.type = 'text';
              input.id = 'field-'+k;
              input.className = 'form-control';
              input.value = v ?? '';
            }

            input.name = k;
            row.appendChild(input);
            body.appendChild(row);
          }

          const editModalEl = document.getElementById('editModal');
          new bootstrap.Modal(editModalEl).show();

          const form = document.getElementById('editForm');
          form.onsubmit = submitDonacionEdit;
        }catch(e){
          console.error('Error al abrir editar', e);
          alert('No se pudo cargar donación para editar.');
        }
      }

      async function submitDonacionEdit(ev){
        ev.preventDefault();
        if(currentEditId === null) return;

        const bodyEl = document.getElementById('editModalBody');
        const inputs = bodyEl.querySelectorAll('[name]');
        const payload = {};
        inputs.forEach(inp => {
          if(inp.type === 'checkbox'){
            payload[inp.name] = inp.checked;
            return;
          }
          if(inp.type === 'number'){
            const val = inp.value;
            payload[inp.name] = val === '' ? null : (val.includes('.') ? parseFloat(val) : parseInt(val,10));
            return;
          }
          payload[inp.name] = inp.value;
        });

        try{
          const resp = await fetch(`/donaciones/api/donaciones/${currentEditId}/`, {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if(!resp.ok){
            let errText = '';
            try { const errJson = await resp.json(); errText = JSON.stringify(errJson); } catch(e){ errText = await resp.text(); }
            console.error('Error en actualización:', resp.status, errText);
            alert('Error guardando: ' + (errText || resp.status));
            return;
          }

          const editModalEl = document.getElementById('editModal');
          bootstrap.Modal.getInstance(editModalEl).hide();
          currentEditId = null;
          await loadDonaciones();
        }catch(err){
          console.error('Error guardando', err);
          alert('No se pudo guardar cambios. Revisa la consola.');
        }
      }

      async function deleteDonacion(id){
        if(!confirm('Eliminar donación #' + id + ' ?')) return;
        try{
          const resp = await fetch(`/donaciones/api/donaciones/${id}/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': csrftoken }
          });
          if(resp.status === 204 || resp.ok){
            await loadDonaciones();
          } else {
            const text = await resp.text();
            console.error('Error eliminar', resp.status, text);
            alert('No se pudo eliminar (revisa permisos).');
          }
        }catch(e){
          console.error('Network error', e);
          alert('Error de red al eliminar.');
        }
      }

      // SOLICITUDES: editar + eliminar
      let currentSolicitudEditId = null;
      async function openSolicitudDetail(id){
        try{
          const resp = await fetch(`/solicitudes/api/solicitudes/${id}/`, { credentials: 'same-origin' });
          if(!resp.ok) throw resp;
          const s = await resp.json();
          const body = document.getElementById('detailModalBody');
          let html = `<h5>${escapeHtml(s.titulo ?? s.tipo ?? `Solicitud #${s.id ?? ''}`)}</h5>`;

          if(s.estado){
            const estadoInfo = badgeClassForEstado(s.estado);
            html += `<p><strong>Estado:</strong> <span class="badge ${estadoInfo.cls}">${escapeHtml(estadoInfo.text)}</span></p>`;
          }

          // Mostrar datos del solicitante (creador)
          if(s.solicitante){
            const p = s.solicitante;
            html += `<hr><div><strong>Solicitante (creador)</strong>
              <dl class="row mb-0">
                <dt class="col-sm-4">ID</dt><dd class="col-sm-8">${escapeHtml(String(p.id ?? ''))}</dd>
                <dt class="col-sm-4">Usuario</dt><dd class="col-sm-8">${escapeHtml(p.usuario ?? p.usuario_completo ?? '')}</dd>
                <dt class="col-sm-4">Email</dt><dd class="col-sm-8">${escapeHtml(p.email ?? '')}</dd>
                <dt class="col-sm-4">Rol</dt><dd class="col-sm-8">${escapeHtml(p.rol ?? '')}</dd>
                <dt class="col-sm-4">Activo</dt><dd class="col-sm-8">${p.activo ? 'Sí' : 'No'}</dd>
              </dl>
            </div>`;
          }

          // Mostrar resto de campos de la solicitud (omitimos solicitante)
          html += '<hr><dl class="row detail-dl">';
          const skip = new Set(['id','titulo','tipo','descripcion','solicitante']);
          for(const [k, v] of Object.entries(s)){
            if(skip.has(k)) continue;
            if(v === null || v === undefined || v === '') continue;
            const label = k.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
            if(typeof v === 'object'){
              html += `<dt class="col-sm-4">${escapeHtml(label)}</dt><dd class="col-sm-8"><pre class="mb-0">${escapeHtml(JSON.stringify(v, null, 2))}</pre></dd>`;
              continue;
            }
            html += `<dt class="col-sm-4">${escapeHtml(label)}</dt><dd class="col-sm-8">${escapeHtml(String(v))}</dd>`;
          }
          html += '</dl>';

          if(s.detalle){
            html += `<hr><div><strong>Detalle</strong><p>${escapeHtml(s.detalle).replace(/\n/g,'<br>')}</p></div>`;
          }

          body.innerHTML = html;
          new bootstrap.Modal(document.getElementById('detailModal')).show();
        }catch(e){
          console.error('Error detalle solicitud', e);
          alert('No se pudo cargar detalle de solicitud.');
        }
      }

      async function submitSolicitudEdit(ev){
        ev.preventDefault();
        if(currentSolicitudEditId === null) return;

        const bodyEl = document.getElementById('editSolicitudModalBody');
        const inputs = bodyEl.querySelectorAll('[name]');
        const payload = {};
        inputs.forEach(inp => {
          if(inp.type === 'checkbox'){
            payload[inp.name] = inp.checked;
            return;
          }
          if(inp.type === 'number'){
            const val = inp.value;
            payload[inp.name] = val === '' ? null : (val.includes('.') ? parseFloat(val) : parseInt(val,10));
            return;
          }
          payload[inp.name] = inp.value;
        });

        try{
          const resp = await fetch(`/solicitudes/api/solicitudes/${currentSolicitudEditId}/`, {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if(!resp.ok){
            let errText = '';
            try { const errJson = await resp.json(); errText = JSON.stringify(errJson); } catch(e){ errText = await resp.text(); }
            console.error('Error en actualización solicitud:', resp.status, errText);
            alert('Error guardando solicitud: ' + (errText || resp.status));
            return;
          }

          const editModalEl = document.getElementById('editSolicitudModal');
          bootstrap.Modal.getInstance(editModalEl).hide();
          currentSolicitudEditId = null;
          await loadSolicitudes();
        }catch(err){
          console.error('Error guardando solicitud', err);
          alert('No se pudo guardar cambios. Revisa la consola.');
        }
      }

      async function deleteSolicitud(id){
        if(!confirm('Eliminar solicitud #' + id + '?')) return;
        try{
          const resp = await fetch(`/solicitudes/api/solicitudes/${id}/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': csrftoken }
          });
          if(resp.status === 204 || resp.ok){
            await loadSolicitudes();
          } else {
            console.error('Error al eliminar', resp.status);
            alert('No se pudo eliminar (revisa permisos)');
          }
        }catch(e){
          console.error('Network error', e);
          alert('Error de red al eliminar.');
        }
      }

      function escapeHtml(str){
        if(str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadDonaciones();
        loadSolicitudes();
      });
    </script>
  </body>
</html>