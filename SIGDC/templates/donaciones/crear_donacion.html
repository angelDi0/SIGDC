<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crear donación - SIGDC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand" href="/usuarios/menu/">SIGDC</a>
    </div>
  </nav>

  <main class="container py-4">
    <h3>Registrar donación</h3>
    <form id="form-donacion" class="mt-3" novalidate>
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">Título</label>
        <input id="titulo" name="titulo" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Descripción</label>
        <textarea id="descripcion" name="descripcion" class="form-control" rows="4"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Dirección</label>
        <input id="direccion" name="direccion" class="form-control">
      </div>

      <div class="d-flex justify-content-end">
        <button id="btn-regresar" type="button" class="btn btn-secondary me-2">Regresar</button>
        <button id="btn-registrar" type="button" class="btn btn-success">Registrar donación</button>
      </div>
    </form>
    <div id="result" class="mt-3 text-danger"></div>
  </main>

  <!-- Modal Confirmar Registro -->
  <div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar registro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Está seguro que desea crear esta donación? Esta acción guardará la información.
        </div>
        <div class="modal-footer">
          <button id="confirmSubmitCancel" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="confirmSubmitConfirm" type="button" class="btn btn-primary">Sí, crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Salir sin guardar -->
  <div class="modal fade" id="confirmLeaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Salir sin guardar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          Los cambios no guardados se perderán. ¿Desea salir al menú sin guardar?
        </div>
        <div class="modal-footer">
          <button id="leaveCancel" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="leaveConfirm" type="button" class="btn btn-danger">Salir sin guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function getCookie(name){
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
      }
      const csrftoken = getCookie('csrftoken');

      // Elementos
      const btnRegistrar = document.getElementById('btn-registrar');
      const btnRegresar = document.getElementById('btn-regresar');
      const resultEl = document.getElementById('result');

      // Inicializar modales (bootstrap ya cargado)
      const confirmSubmitModalEl = document.getElementById('confirmSubmitModal');
      const confirmLeaveModalEl = document.getElementById('confirmLeaveModal');
      const bsConfirmSubmit = new bootstrap.Modal(confirmSubmitModalEl);
      const bsConfirmLeave = new bootstrap.Modal(confirmLeaveModalEl);

      // Mostrar modal de confirmación de registro
      btnRegistrar.addEventListener('click', function () {
        bsConfirmSubmit.show();
      });

      // Mostrar modal de confirmar salida sin guardar
      btnRegresar.addEventListener('click', function () {
        bsConfirmLeave.show();
      });

      // Confirmar salida: redirigir al menú
      document.getElementById('leaveConfirm').addEventListener('click', function () {
        window.location.replace('/usuarios/menu/');
      });

      // Acción real de envío cuando confirman crear
      document.getElementById('confirmSubmitConfirm').addEventListener('click', async function () {
        bsConfirmSubmit.hide();
        resultEl.textContent = '';

        const payload = {
          titulo: document.getElementById('titulo').value || '',
          descripcion: document.getElementById('descripcion').value || '',
          direccion: document.getElementById('direccion').value || ''
        };

        try {
          const resp = await fetch('/donaciones/api/donaciones/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
          });

          const dataText = await resp.text();
          let data;
          try { data = JSON.parse(dataText); } catch { throw new Error(dataText || 'Respuesta no válida'); }

          if (!resp.ok) {
            const msg = (typeof data === 'object') ? JSON.stringify(data) : String(data);
            throw new Error(msg);
          }

          // éxito: redirigir al menú (recarga automática)
          window.location.replace('/usuarios/menu/');
        } catch (err) {
          console.error(err);
          resultEl.textContent = 'Error al crear donación: ' + err.message;
        }
      });

      // Opcional: cerrar modal de confirmación con ESC o click fuera ya lo maneja bootstrap
      // Opcional: prevenir navegación accidental si hay cambios (no implementado aquí)
    });
  </script>
</body>
</html>