<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crear solicitud - SIGDC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">Registrar solicitud</h3>
    </div>

    <form id="form-solicitud" class="mt-3" novalidate>
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">Título</label>
        <input id="titulo" name="titulo" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Detalle</label>
        <textarea id="detalle" name="detalle" class="form-control" rows="4"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Cantidad</label>
        <input id="cantidad" name="cantidad" type="number" min="0" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Tipo</label>
        <input id="tipo" name="tipo" class="form-control">
      </div>

      <div class="d-flex justify-content-end">
        <a class="btn btn-outline-secondary me-2" href="/usuarios/menu/">Regresar</a>
        <button id="btn-submit" type="button" class="btn btn-primary">Registrar solicitud</button>
      </div>
    </form>

    <div id="result" class="mt-3 text-danger"></div>
  </main>

  <!-- Modal de confirmación -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar creación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>Vas a crear la siguiente solicitud:</p>
          <dl class="row mb-0">
            <dt class="col-sm-4">Título</dt><dd class="col-sm-8" id="confirm-titulo"></dd>
            <dt class="col-sm-4">Detalle</dt><dd class="col-sm-8" id="confirm-detalle"></dd>
            <dt class="col-sm-4">Cantidad</dt><dd class="col-sm-8" id="confirm-cantidad"></dd>
            <dt class="col-sm-4">Tipo</dt><dd class="col-sm-8" id="confirm-tipo"></dd>
          </dl>
        </div>
        <div class="modal-footer">
          <button id="confirm-cancel" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="confirm-ok" type="button" class="btn btn-primary">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    // función para obtener el token CSRF
    function getCookie(name){
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

    const confirmModalEl = document.getElementById('confirmModal');
    const confirmModal = new bootstrap.Modal(confirmModalEl);

    // muestra el modal de confirmación con los datos
    document.getElementById('btn-submit').addEventListener('click', function(){
      document.getElementById('confirm-titulo').textContent = document.getElementById('titulo').value || '—';
      document.getElementById('confirm-detalle').textContent = document.getElementById('detalle').value || '—';
      const cant = document.getElementById('cantidad').value;
      document.getElementById('confirm-cantidad').textContent = (cant === '') ? '—' : cant;
      document.getElementById('confirm-tipo').textContent = document.getElementById('tipo').value || '—';
      confirmModal.show();
    });

    
    document.getElementById('confirm-ok').addEventListener('click', function(){
      document.getElementById('result').textContent = '';

      const data = {
        titulo: document.getElementById('titulo').value || '',
        detalle: document.getElementById('detalle').value || '',
        cantidad: (document.getElementById('cantidad').value === '') ? null : parseInt(document.getElementById('cantidad').value, 10),
        tipo: document.getElementById('tipo').value || ''
      };

      fetch('/solicitudes/api/solicitudes/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json'
        },
        body: JSON.stringify(data)
      })
      //Revisa si la respuesta fue correcta
      .then(resp => {
        if (!resp.ok) {
          return resp.text().then(text => {
            throw new Error(text || 'Error HTTP ' + resp.status);
          });
        }
        return resp.json(); // si fue correcta, parsea el JSON
      })
      // Muestra el resultado y redirige
      .then(payload => {
        console.log('Solicitud creada:', payload);
        window.location.replace('/usuarios/menu/');
      })
      
      .catch(err => {
        console.error('Error:', err);
        const msg = err.message.includes('Authentication')
          ? 'No estás autenticado. Inicia sesión.'
          : 'Error al crear solicitud.';

        document.getElementById('result').textContent = msg;
        confirmModal.hide();
      });
    });
  })();
  </script>
</body>
</html>
