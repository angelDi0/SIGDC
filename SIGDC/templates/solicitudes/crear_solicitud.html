<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crear solicitud - SIGDC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand" href="{% url 'usuarios:menu' %}">SIGDC</a>
      <div>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'usuarios:logout' %}">Salir</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h3>Registrar solicitud</h3>
    <form id="form-solicitud" class="mt-3">
      {% csrf_token %}
      <input type="hidden" name="tipo" value="{{ request.GET.tipo|default:'' }}">
      <div class="mb-3">
        <label class="form-label">Título</label>
        <input id="titulo" name="titulo" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Detalle</label>
        <textarea id="detalle" name="detalle" class="form-control" rows="4"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Cantidad</label>
        <input id="cantidad" name="cantidad" type="number" min="0" class="form-control">
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Registrar solicitud</button>
      </div>
    </form>
    <div id="result" class="mt-3"></div>
  </main>

  <script>
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

    document.getElementById('form-solicitud').addEventListener('submit', function(e){
      e.preventDefault();
      const data = {
        titulo: document.getElementById('titulo').value,
        detalle: document.getElementById('detalle').value,
        cantidad: parseInt(document.getElementById('cantidad').value) || null,
        tipo: document.querySelector('input[name="tipo"]').value || ''
      };

      // promesas encadenadas: crear -> listar
      fetch('/solicitudes/api/solicitudes/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
      })
      .then(resp => {
        if (!resp.ok) throw resp;
        return resp.json();
      })
      .then(created => {
        document.getElementById('result').innerText = 'Solicitud creada: ' + created.id;
        // ahora obtenemos lista actualizada
        return fetch('/solicitudes/api/solicitudes/');
      })
      .then(resp => resp.json())
      .then(list => {
        // reemplazar por actualización de DOM real
        document.getElementById('result').innerText += '\nTotal solicitudes: ' + list.length;
      })
      .catch(err => {
        console.error(err);
        document.getElementById('result').innerText = 'Error al crear solicitud.';
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>