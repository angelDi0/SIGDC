<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crear solicitud - SIGDC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <main class="container py-4">
    <h3>Registrar solicitud</h3>
    <form id="form-solicitud" class="mt-3">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">TÃ­tulo</label>
        <input id="titulo" name="titulo" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Detalle</label>
        <textarea id="detalle" name="detalle" class="form-control" rows="4"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Cantidad</label>
        <input id="cantidad" name="cantidad" type="number" min="0" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Tipo</label>
        <input id="tipo" name="tipo" class="form-control">
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Registrar solicitud</button>
      </div>
    </form>
    <div id="result" class="mt-3"></div>
  </main>

  <script>
  function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v? v.pop():''; }
  const csrftoken = getCookie('csrftoken');

  document.getElementById('form-solicitud').addEventListener('submit', function(e){
    e.preventDefault();
    const data = {
      titulo: document.getElementById('titulo').value,
      detalle: document.getElementById('detalle').value,
      cantidad: parseInt(document.getElementById('cantidad').value) || null,
      tipo: document.getElementById('tipo').value || ''
    };

    // promesas encadenadas: crear -> listar actualizado
    fetch('/solicitudes/api/solicitudes/', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(data)
    })
    .then(r => { if (!r.ok) throw r; return r.json(); })
    .then(created => {
      document.getElementById('result').innerText = 'Solicitud creada: ' + created.id;
      return fetch('/solicitudes/api/solicitudes/');
    })
    .then(r => r.json())
    .then(list => {
      document.getElementById('result').innerText += '\\nTotal solicitudes: ' + list.length;
    })
    .catch(err => {
      console.error(err);
      document.getElementById('result').innerText = 'Error al crear solicitud';
    });
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>